<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pointillist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="lib/bootstrap-2.0.2/css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="lib/leaflet-0.3.1/leaflet.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="lib/leaflet-0.3.1/leaflet.ie.css" />
    <![endif]-->
    <link rel="stylesheet" href="css/bootstrap.map.css" />
    <link href="lib/bootstrap-2.0.2/css/bootstrap-responsive.css" rel="stylesheet">
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <style>
      /* TODO: This style is not applied for some reason */
      @media (max-width: 767px) {
        .hidden-phone {
          display: none !important;
        }
      }
    </style>

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="lib/bootstrap-2.0.2/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="lib/bootstrap-2.0.2/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="lib/bootstrap-2.0.2/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="lib/bootstrap-2.0.2/ico/apple-touch-icon-57-precomposed.png">
  </head>

  <body class="map">
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
           <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
           <a class="brand" href="#">Pointillist Demo</a>
           <div class="nav-collapse">
             <form class="navbar-search pull-right" action="">
              <input type="text" class="search-query span4" placeholder="Search Tweets">
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span12">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <script src="lib/leaflet-0.4b/leaflet.js"></script>
    <script src="lib/jquery-1.7.1/jquery.min.js"></script>
    <script src="lib/bootstrap-2.0.2/js/bootstrap.min.js"></script>
    <script src="lib/globalmaptiles.js"></script>
    <script src="js/pointillist.js"></script>
    <script>
      var map = new L.Map('map'),
          layerGroup = new L.LayerGroup(),
          cloudmadeUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/54789/256/{z}/{x}/{y}.png',
          cloudmadeAttribution = 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
          cloudmade = new L.TileLayer(cloudmadeUrl, {maxZoom: 18, attribution: cloudmadeAttribution}),
          layers = {},
          rectangle = true,
          tree;

      map.setView(new L.LatLng(39.828175, -98.579500), 4)
        .addLayer(cloudmade)
        .addLayer(layerGroup);


      Pointillist.Cell.prototype.expand = function() {
        var i;

        layerGroup.removeLayer(layers[[this.x, this.y, this.z]]);
        delete layers[[this.x, this.y, this.z]];

        for(i=0; i<this.children.length; i++) {
          layers[[this.children[i].x, this.children[i].y, this.children[i].z]] = makeLayer(this.children[i]);
        }

        draw();
      };

      map.on('click', function(evt) {
        // console.log(evt.latlng);
        addPoint(evt.latlng.lat, evt.latlng.lng);
      });

      function makeLayer(cell) {
        var c = cell.getLatLonCenter(),
            ll = new L.LatLng(c[0], c[1]),
            b = new L.LatLngBounds(
              new L.LatLng(cell.latLonBounds[0], cell.latLonBounds[1]),
              new L.LatLng(cell.latLonBounds[2], cell.latLonBounds[3])
            );

        return new L.Rectangle(b, {
          weight: 0.5,
          opacity: 0.8
        });;

        // return new L.Circle(ll, ll.distanceTo(new L.LatLng(cell.latLonBounds[2], ll.lng)), {
        //   weight: 1,
        //   opacity: 0.8
        // });
      }

      function draw() {
        for (key in layers) {
          layerGroup.addLayer(layers[key]);
        }
      }

      function init(query) {
        var i;

        layerGroup.clearLayers();

        layers = {};
        tree = new Pointillist.Tree({
          maxZoom: 11
        });

        for (i=0; i<tree.topCells.length; i++) {
          layers[[tree.topCells[i].x, tree.topCells[i].y, tree.topCells[i].z]] = makeLayer(tree.topCells[i]);
        }
        draw();

        getTweets(query, function(tweets) {
          var i;
          for (i=0; i<tweets.results.length; i++) {
            if (tweets.results[i].location) {
              (function(tweet, ii){
                setTimeout(function(){
                  geocode(tweet.location, function(res){
                    // console.log(res.latitude + ' ' + tweet.location)
                    // console.log(res);
                    addPoint(parseFloat(res.latitude), parseFloat(res.longitude));
                  });
                }, 100*ii);
              })(tweets.results[i], i);
            }
          }
          // console.log(tweets);
        });
      }

      function getTweets(query, callback) {
        $.ajax({
            url: 'http://search.twitter.com/search.json',
            dataType: 'jsonp',
            data: {
              q: query,
              rpp: 100,
              geocode: '39.828175,-98.579500,1500mi'

            },
            success: function(data){
              callback(data);
            }
        });
      }

      function geocode(addr, callback) {
        $.ajax({
          dataType: 'jsonp',
          data: {
            q: 'select * from geo.placefinder where text="'+addr+'"',
            format: 'json',
            appid: 'test'
          },
          url: 'http://query.yahooapis.com/v1/public/yql',
          success: function (res) {
            if (res.query.count || (res.query.results && $.isArray(res.query.results.Result) && res.query.results.Result.length > 0)) {
              // For some reason, this sometimes comes back as an array. Sad.
              if ($.isArray(res.query.results.Result)) {
                callback(res.query.results.Result[0]);
              } else {
                callback(res.query.results.Result);
              }
            }
          }
        });
      }

      function addPoint(lat, lon) {
        var i;

        for (i=0; i<tree.topCells.length; i++) {
          // addPoint checks to make sure the lat/lon is contained
          tree.topCells[i].addPoint(lat, lon);
        }
      }

      $(document).ready(function(){
        $('.navbar-search').submit(function(evt) {
          evt.preventDefault();
          init($('.search-query').val());
        });
      });
    </script>

  </body>
</html>
